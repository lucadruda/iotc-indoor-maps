{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "accountName": {
            "type": "string",
            "defaultValue": "[uniqueString(resourceGroup().id)]",
            "metadata": {
                "description": "The name for your Azure Maps account. This value must be globally unique."
            }
        },
        "websitedomain": {
            "type": "string",
            "metadata": {
                "description": "The domain name for the website. <domain>.azurewebsites.net"
            }
        },
        "pricingTier": {
            "type": "string",
            "allowedValues": [
                "S0",
                "S1",
                "G2"
            ],
            "defaultValue": "G2",
            "metadata": {
                "description": "The pricing tier for the account. Use S0 for small-scale development. Use S1 or G2 for large-scale applications."
            }
        },
        "kind": {
            "type": "string",
            "allowedValues": [
                "Gen1",
                "Gen2"
            ],
            "defaultValue": "Gen2",
            "metadata": {
                "description": "The pricing tier for the account. Use Gen1 for small-scale development. Use Gen2 for large-scale applications."
            }
        }
    },
    "variables": {
        "mapAccountName": "[parameters('accountName')]",
        "creatorName": "[concat(variables('mapAccountName'),'-creator')]",
        "sku": "Free",
        "skucode": "Free",
        "repositoryUrl": "https://github.com/lucadruda/iotc-indoor-maps",
        "repositoryBranch": "indoor_maps",
        "appLocation": "/",
        "appArtifactLocation": "map-react",
        "appBuildCommand": "npm run build",
        "siteName": "[concat('appsvc-',uniqueString(resourceGroup().id))]"

    },
    "resources": [
        {
            "name": "[variables('mapAccountName')]",
            "type": "Microsoft.Maps/accounts",
            "apiVersion": "2021-02-01",
            "location": "global",
            "sku": {
                "name": "[parameters('pricingTier')]"
            },
            "kind": "[parameters('kind')]",
            "properties": {},
            "resources": [
                {
                    "type": "creators",
                    "apiVersion": "2021-02-01",
                    "properties": {
                        "storageUnits": 1
                    },
                    "name": "[variables('creatorName')]",
                    "location": "[if(contains(resourceGroup().location,'eur'),'westeurope','eastus2')]",
                    "dependsOn": [ "[resourceId('Microsoft.Maps/accounts', variables('mapAccountName'))]" ]
                }
            ]
        },
        {
            "type": "Microsoft.Web/staticSites",
            "apiVersion": "2020-12-01",
            "name": "[variables('siteName')]",
            "location": "[resourceGroup().location]",
            "kind": "app,linux",
            "properties": {
                "enabled": true,
                "hostNameSslStates": [
                    {
                        "name": "[concat(parameters('websitedomain'), '.azurewebsites.net')]",
                        "sslState": "Disabled",
                        "hostType": "Standard"
                    },
                    {
                        "name": "[concat(parameters('websitedomain'), '.scm.azurewebsites.net')]",
                        "sslState": "Disabled",
                        "hostType": "Repository"
                    }
                ],
                "repositoryUrl": "[variables('repositoryUrl')]",
                "branch": "[variables('repositoryBranch')]",
                "buildProperties": {
                    "appLocation": "[variables('appLocation')]",
                    "appBuildCommand": "[variables('appBuildCommand')]",
                    "appArtifactLocation": "[variables('appArtifactLocation')]"
                }
            },
            "sku": {
                "Tier": "[variables('sku')]",
                "Name": "[variables('skuCode')]"
            },
            "resources": [
                {
                    "apiVersion": "2020-12-01",
                    "name": "appsettings",
                    "type": "config",
                    "location": "[resourceGroup().location]",
                    "properties": {
                        "MAP_SUBSCRIPTION_KEY": "[listKeys(concat('Microsoft.Maps/accounts/',parameters('accountName')),'2021-02-01').primaryKey]"
                    },
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/staticSites', variables('siteName'))]"
                    ]
                }
            ],
            "dependsOn": [ "[resourceId('Microsoft.Maps/accounts/creators', variables('mapAccountName'),variables('creatorName'))]" ]
        }

    ],
    "outputs": {
        "subscriptionId": {
            "value": "[subscription().subscriptionId]",
            "type": "string"
        },
        "resourceId": {
            "value": "[resourceId('Microsoft.Maps/accounts',parameters('accountName'))]",
            "type": "string"
        },
        "tenantId": {
            "value": "[subscription().tenantId]",
            "type": "string"
        },
        "location": {
            "value": "[if(contains(resourceGroup().location,'eur'),'eu','us')]",
            "type": "string"
        },
        "mapSubscriptionKey": {
            "value": "[listKeys(concat('Microsoft.Maps/accounts/',parameters('accountName')),'2021-02-01').primaryKey]",
            "type": "string"
        }
    }
}